import{_ as s,o as n,c as a,O as l}from"./chunks/framework.4afe7240.js";const F=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"Cesium-3DTiles.md","filePath":"Cesium-3DTiles.md"}'),p={name:"Cesium-3DTiles.md"},o=l(`<blockquote><p>Cesium从版本 v1.35(2017-07-05) 就已经开始提供对 3D Tiles 1.0 草案的支持，并持续保持对最新3D Tiles 规格的支持更新</p></blockquote><h2 id="_3dtiles下载器爬虫" tabindex="-1">3DTiles下载器爬虫 <a class="header-anchor" href="#_3dtiles下载器爬虫" aria-label="Permalink to &quot;3DTiles下载器爬虫&quot;">​</a></h2><ol><li><a href="https://github.com/WangMingHua111/3dtilesdownloader" target="_blank" rel="noreferrer">WangMingHua111/3dtilesdownloader: 3dtiles 网络文件下载器</a> 上次更新2021 年 8 月 ，npm cli包，试了，下载的是cesiumlab的clt，自动解包是空文件夹，无效❌</li><li><a href="https://github.com/IKangXu/3dtilesdownloader" target="_blank" rel="noreferrer">IKangXu/3dtilesdownloader: 下载在线3dtiles数据，可自指定多线程数，可分段下载，可指定位置下载。</a> 上次更新2022 年 10 月，py3写的，可下载external tilesets（我称之为层级tilesets）</li></ol><blockquote><p>3D Tiles 支持多个其他 JSON 文件的 JSON 索引。这是通过使用external tilesets外部瓦片集实现的，外部瓦片集是使用 URL 或相对路径引用其他瓦片集的 JSON 文件。 通过这种方式，单个顶级 tileset JSON 文件可以引用和索引多个其他 tilesets，从而实现大型 3D 数据集的高效组织和管理。每个引用的图块集都可以包含自己的图块集、属性和元数据，并且可以独立于其他图块加载和显示。</p></blockquote><ol start="3"><li><a href="https://github.com/CHENJIAMIAN/xt3d-local-debug" target="_blank" rel="noreferrer">CHENJIAMIAN/xt3d-local-debug: xt3d.js本地调试</a> 里包含了2023年5月5日最新可用的几个下载器，是我整理归纳的</li></ol><h2 id="_3dtiles" tabindex="-1">3DTiles <a class="header-anchor" href="#_3dtiles" aria-label="Permalink to &quot;3DTiles&quot;">​</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">3DTiles </span><span style="color:#F78C6C;">1.0</span><span style="color:#A6ACCD;"> 规范允许异构数据共存于一个数据集上。3D 瓦片只是空间划分的单元，并不是该块三维空域内的具体三维物体。这些三维物体被称作“瓦片内容”。</span></span>
<span class="line"><span style="color:#A6ACCD;">    简单地理解为带有 LOD 的 glTF</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//http://mars3d.cn/dev/guide/map/tileset.html#_3-2-lod%E6%A0%91%E7%BB%93%E6%9E%84</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">1.0</span><span style="color:#A6ACCD;"> 允许存在 </span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;"> 种瓦片内容，它们的文件后缀名是：          </span></span>
<span class="line"><span style="color:#A6ACCD;">        B3DM代表“Batched 3D Model”，它是一种基于glTF格式的3D数据模型。它可以包含多个独立的3D模型，并将它们合并成一个单独的文件，从而提高了加载和渲染速度。</span></span>
<span class="line"><span style="color:#89DDFF;">	        </span><span style="color:#676E95;font-style:italic;">//B3DM通常用于存储建筑物、道路、桥梁等人工结构的3D模型。</span></span>
<span class="line"><span style="color:#89DDFF;">	        </span><span style="color:#676E95;font-style:italic;">//B3DM(批量3D模型) = featureTable 记录渲染相关的数据 + batchTable记录属性数据 + glb     </span></span>
<span class="line"><span style="color:#A6ACCD;">				featureTable，记录的是整个瓦片渲染相关的数据，而不是渲染所需的数据。</span></span>
<span class="line"><span style="color:#A6ACCD;">					渲染相关，即有多少个模型，坐标是相对的话相对于哪个中心，如果是点云的话颜色信息是什么以及坐标如何等；</span></span>
<span class="line"><span style="color:#A6ACCD;">					渲染所需，例如顶点信息、法线贴图材质信息均有glb部分完成。</span></span>
<span class="line"><span style="color:#A6ACCD;">				batchTable</span></span>
<span class="line"><span style="color:#A6ACCD;">					# 记录属性数据</span></span>
<span class="line"><span style="color:#A6ACCD;">					在一个瓦片中，一个三维</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">要素</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">（GIS中的通常叫法）</span></span>
<span class="line"><span style="color:#A6ACCD;">						</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> 一个</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">模型</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">（图形学、工业建模叫法） </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> 一个</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">BATCH</span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;">（3dtiles叫法）</span></span>
<span class="line"><span style="color:#A6ACCD;">	        glb  </span><span style="color:#676E95;font-style:italic;">// glTF binary 化,glTF //（TF传输格式）是一种使用 JSON标准的 3D场景和模型的文件格式</span></span>
<span class="line"><span style="color:#A6ACCD;">		I3DM代表“Instanced 3D Model”，它也是基于glTF格式的3D数据模型，但它包含了多个实例化的3D模型，每个实例都有自己的变换矩阵和材质属性。</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">//因此，I3DM通常用于存储大规模场景中的重复对象，如树木、草丛、石头等自然元素。</span></span>
<span class="line"><span style="color:#A6ACCD;">        pnts，点云</span></span>
<span class="line"><span style="color:#A6ACCD;">        cmpt，复合格式，即前三者的混合体，合并细碎瓦片内容文件成一个，减少网络请求</span></span>
<span class="line"><span style="color:#A6ACCD;">        vctr，矢量瓦片，未正式发布，本篇不讨论</span></span>
<span class="line"><span style="color:#A6ACCD;">        json，这种叫做扩展数据集（ExternalTileset），即允许瓦片空域内再嵌套一个子 3DTiles</span></span>
<span class="line"><span style="color:#A6ACCD;">        空瓦片，即瓦片无内容</span></span>
<span class="line"><span style="color:#A6ACCD;">    而 </span><span style="color:#F78C6C;">1.0</span><span style="color:#A6ACCD;"> 的扩展项，也就是下一代标准增加了一种瓦片格式：</span></span>
<span class="line"><span style="color:#A6ACCD;">        glb</span><span style="color:#676E95;font-style:italic;">//gltf，也就是直接将 glTF 模型文件作为瓦片内容文件</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">    cesium可以读取tileset中的</span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">geometricError</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">:</span><span style="color:#F78C6C;">180.82317494275</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">用来干什么</span></span>
<span class="line"><span style="color:#A6ACCD;">	    一般单位是米（m），每个子tile孙子tile都有这个值，越精细的值越小，孙子的这个值比它爹小</span></span>
<span class="line"><span style="color:#A6ACCD;">        tileset 中的几何误差信息，如果几何误差较低，Cesium 可能加载更多的瓦片，以获得更高精度的图形。</span></span>
<span class="line"><span style="color:#A6ACCD;">        如果几何误差较高，Cesium 可能加载更少的瓦片，以提高性能</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">确定瓦片的加载方式</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">//在webgl层级决定三角形剖分的程度</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span></span>
<span class="line"><span style="color:#A6ACCD;">3DTILES的root的</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">transform</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">: [</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1.1348381601623395</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">0.2899580508025771</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">0.414291999686242</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">//x、y、z三个轴向上的缩放比例</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">0.13570189487791788</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">0.33968642889259656</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">0.6094602447327197</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">//x、y、z三个轴向旋转的角度(弧度or度)</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">0.7711452290402661</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">1.8167044083464686</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">0.8408488797207132</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">//x、y、z平移</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">2293908.7750967207</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">5404110.700716343</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">2484510.344405871</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">1</span><span style="color:#676E95;font-style:italic;">//3D Tiles数据集在全局坐标系中的位置</span></span>
<span class="line"><span style="color:#A6ACCD;">		]对于使用3D Tiles的应用程序来说，root transform的作用是将3D Tiles数据的本地坐标系映射到应用程序的全局坐标系，以便正确地显示和处理3D模型和场景。</span></span></code></pre></div><h2 id="源码结构-1-104版本" tabindex="-1">源码结构 1.104版本 <a class="header-anchor" href="#源码结构-1-104版本" aria-label="Permalink to &quot;源码结构 1.104版本&quot;">​</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了3D Tiles集合对象，它是一个包含多个3D Tiles图块的容器。集合对象可以加载和渲染大量的3D Tiles数据，并提供一组方法用于控制3D场景中的3D Tiles实体。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span><span style="color:#676E95;font-style:italic;">//Cesium3DTile.js是Cesium 3D Tiles库的主要文件，它定义了一组类和函数，用于加载、渲染和操作3D Tiles数据。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileBatchTable</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了批量表对象，这是一种存储与3D Tiles实体相关的元数据的机制。批量表可以存储任何类型的数据，例如颜色、材质、名称等。批量表适用于大量实体共享相同属性的场景。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileColorBlendMode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组颜色混合模式，用于控制在渲染3D Tiles时如何混合不同实体的颜色。例如，可以使用混合模式将半透明的实体与其他实体混合，以创建透明效果。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileContent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了3D Tiles内容对象，该对象包含了一个或多个3D Tiles图块的几何数据和元数据。内容对象可以包含多个3D Tiles特征，每个特征都是一个实体或对象，具有自己的位置、几何形状和属性。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileContentFactory</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//是一个工厂类，用于创建3D Tiles内容对象。它接受3D Tiles图块数据和元数据，并根据其内容类型返回适当的内容对象。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileContentState</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组状态，用于跟踪3D Tiles内容对象的加载和渲染状态。这些状态包括未加载、正在加载、已加载、正在渲染和已渲染。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileContentType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组3D Tiles内容类型，例如点、线和面。这些类型用于确定要在3D场景中呈现哪些几何形状。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileFeature</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了3D Tiles特征对象，该对象表示3D Tiles实体的一个实例。特征对象包含实体的位置、几何形状和属性数据。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileFeatureTable</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了特征表对象，它是一种存储3D Tiles特征属性数据的机制。特征表可以存储任何类型的数据，例如颜色、材质、名称等。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileOptimizationHint</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组优化提示，用于在3D Tiles加载和渲染过程中优化性能。例如，可以使用优化提示告诉引擎何时缩小图块的数量，以改善性能。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileOptimizations</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组优化选项，用于控制在3D Tiles加载和渲染过程中应用哪些优化。例如，可以使用优化选项来关闭半透明实体渲染、开启LOD（级别细节）渲染等。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilePass</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组通道，用于控制在3D Tiles加载和渲染过程中应该如何处理不同类型的实体。例如，可以使用通道将透明实体与不透明实体分开渲染，以避免混合问题。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilePassState</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组通道状态，用于跟踪3D Tiles加载和渲染过程中通道的状态。这些状态包括通道是否启用、通道的深度测试和混合模式等。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilePointFeature</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组点特征对象，该对象表示3D Tiles中的点实体。点特征对象包含实体的位置、大小、颜色和属性数据。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组细化选项，用于控制在3D Tiles加载和渲染过程中如何细化图块。细化选项可以控制在哪个级别上细化、是否细化到最细级别等。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileStyle</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一种样式语言，用于在3DTiles中定义实体的样式和外观。样式可以控制实体的颜色、大小、材质、可见性等属性。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileStyleEngine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//是一个样式引擎，用于解析和应用3D Tiles样式语言。它接受一个样式字符串，并将其转换为实体的属性和样式。	</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesetBaseTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组遍历算法，用于遍历3D Tiles图块的层次结构。遍历算法可以优化3D Tiles数据的加载和渲染，以提高性能和效率。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesetCache</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一个缓存对象，用于存储3D Tiles图块的数据和元数据。缓存对象可以提高3D Tiles数据的加载速度和性能。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesetHeatmap</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一种热力图算法，用于在3D Tiles中可视化数据。热力图可以将数据表示为不同颜色的热点，以帮助用户更直观地理解数据。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesetMetadata</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组元数据对象，用于存储3D Tiles实体的附加信息。元数据可以存储任何类型的数据，例如时间戳、描述、标签等。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesetMostDetailedTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//加载与相机平截头体相交的所有叶子的遍历。用于在 pickFromRayMostDetailed 调用期间确定光线瓦片集的交点。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesetSkipTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一种跳过遍历算法，用于在3D Tiles中跳过不需要加载和渲染的图块。这种遍历算法可以提高3D场景的加载速度和性能。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesetStatistics</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组统计信息，用于跟踪3D Tiles数据的加载和渲染。统计信息可以提供有关3D场景性能和效率的有用信息。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesetTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//定义了一组遍历算法，用于遍历3D Tiles图块的层次结构。遍历算法可以优化3D Tiles数据的加载和渲染，以提高性能和效率。</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTilesVoxelProvider</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#676E95;font-style:italic;">//从 3D Tiles tileset 中获取体素数据</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#A6ACCD;">依赖关系	</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileContentFactory</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileContentState</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileContentType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileOptimizationHint</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTilePass</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTileColorBlendMode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTileContentState</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTilesetMetadata</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTileOptimizations</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileOptimizationHint</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTilePass</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTilesetCache</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTilesetHeatmap</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTilesetStatistics</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTileStyleEngine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTilesetMostDetailedTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTilesetTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	          Cesium3DTileOptimizationHint</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	          Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTilesetBaseTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTilesetTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	          Cesium3DTileOptimizationHint</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	          Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	    Cesium3DTilesetSkipTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	       Cesium3DTilesetTraversal</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	          Cesium3DTileOptimizationHint</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	          Cesium3DTileRefine</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span></code></pre></div><h2 id="tileset-json文件" tabindex="-1">tileset.json文件 <a class="header-anchor" href="#tileset-json文件" aria-label="Permalink to &quot;tileset.json文件&quot;">​</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">1.</span><span style="color:#A6ACCD;"> asset：表示数据集相关信息，例如版本、作者、生成工具等。</span></span>
<span class="line"><span style="color:#F78C6C;">2.</span><span style="color:#A6ACCD;"> geometricError：表示瓦片精度，即瓦片相对于父瓦片的误差范围。</span></span>
<span class="line"><span style="color:#F78C6C;">3.</span><span style="color:#A6ACCD;"> root：表示整个数据集根瓦片的位置和属性，例如瓦片边界、坐标系等。</span></span>
<span class="line"><span style="color:#F78C6C;">4.</span><span style="color:#A6ACCD;"> properties：表示数据集中可能包含的自定义属性。</span></span>
<span class="line"><span style="color:#F78C6C;">5.</span><span style="color:#A6ACCD;"> extensions：表示3D Tiles规范中使用的扩展，例如Batch Table和Feature Table等。</span></span>
<span class="line"><span style="color:#F78C6C;">6.</span><span style="color:#A6ACCD;"> extras：表示额外的元数据，通常用于应用程序特定的元数据。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Tileset JSON文件还可以包含其他属性，例如LOD细节级别、子瓦片的链接关系等。</span></span>
<span class="line"><span style="color:#A6ACCD;">Tileset JSON文件仅作为数据集的描述文件，不包括实际的3D模型数据。每个瓦片的实际数据存储在不同的glTF文件中。</span></span></code></pre></div><h3 id="说说root" tabindex="-1">说说root <a class="header-anchor" href="#说说root" aria-label="Permalink to &quot;说说root&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">在3D Tiles数据集中，root表示整个数据集的根瓦片。Tileset JSON文件中的root属性包含了描述根瓦片的信息，如下所示：</span></span>
<span class="line"><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">: </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">boundingVolume</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{...},</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">geometricError</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200.0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">refine</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ADD</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">content</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">		</span></span>
<span class="line"><span style="color:#A6ACCD;">	    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">uri</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">gltf等模型的地址</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">boundingVolume</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">//&quot;box&quot;：表示边界体积为一个长方体，其位置和大小由&quot;box&quot;属性指定；</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">//&quot;region&quot;：表示边界体积为一个地理区域，由&quot;region&quot;属性指定；</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">//&quot;sphere&quot;：表示边界体积为一个球体，由&quot;sphere&quot;属性指定；</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">//&quot;tileset&quot;：表示边界体积为整个数据集，由&quot;tileset&quot;属性指定。</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">box</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#F78C6C;">50.0694580078125</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">75.6625518798828</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">34.4871654510498</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">整体代表什么，每个数各代表什么</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#F78C6C;">421.810821533203</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">393.366622924805</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">52.166711807251</span></span>
<span class="line"><span style="color:#A6ACCD;">			]</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">//或\`region\`属性的值为\`[-1.3197209591796106, 0.6988424218, -1.3196390408203893, 0.6989055782, 0, 88]\`，</span></span>
<span class="line"><span style="color:#89DDFF;">				</span><span style="color:#676E95;font-style:italic;">//表示该模型所在的区域位于经度-1.31972到-1.31964之间、纬度0.69884到0.69891之间，高度范围为0到88米。</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;">这个包围盒是通过一个长方体盒子（box）来表示的，包含了以下12个数值：		</span></span>
<span class="line"><span style="color:#A6ACCD;">	-   前三个数（</span><span style="color:#F78C6C;">50.0694580078125</span><span style="color:#F07178;">，</span><span style="color:#F78C6C;">75.6625518798828</span><span style="color:#F07178;">，</span><span style="color:#F78C6C;">34.4871654510498</span><span style="color:#F07178;">）表示盒子的中心点在三维坐标系中的位置（x、y、z轴坐标）。</span></span>
<span class="line"><span style="color:#F07178;">	-   接下来三个数（</span><span style="color:#F78C6C;">421.810821533203</span><span style="color:#F07178;">，</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">，</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">）表示盒子在x轴上的长度、y轴和z轴上的长度。</span></span>
<span class="line"><span style="color:#F07178;">	-   再接下来三个数（</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">，</span><span style="color:#F78C6C;">393.366622924805</span><span style="color:#F07178;">，</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">）表示盒子在y轴上的长度、x轴和z轴上的长度。</span></span>
<span class="line"><span style="color:#F07178;">	-   最后三个数（</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">，</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">，</span><span style="color:#F78C6C;">52.166711807251</span><span style="color:#F07178;">）表示盒子在z轴上的长度、x轴和y轴上的长度。	    </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    children: 类root</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">其中：</span></span>
<span class="line"><span style="color:#F78C6C;">1.</span><span style="color:#A6ACCD;"> boundingVolume：描述根瓦片的边界体积，可以是一个包围盒或者球体。</span></span>
<span class="line"><span style="color:#F78C6C;">2.</span><span style="color:#A6ACCD;"> geometricError：描述根瓦片相对于父瓦片的误差范围，通常为最大误差距离的一半。</span></span>
<span class="line"><span style="color:#F78C6C;">3.</span><span style="color:#A6ACCD;"> refine：描述根瓦片进一步细分的方式，可以是</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ADD</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">或者</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">REPLACE</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">。</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ADD</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">表示在当前精度级别上添加更多子瓦片，</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">REPLACE</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">表示用更高精度的瓦片替换当前瓦片。</span></span>
<span class="line"><span style="color:#F78C6C;">4.</span><span style="color:#A6ACCD;"> content：描述根瓦片实际包含的数据。通常指向包含根瓦片数据的glTF文件或多个glTF文件的文件夹路径。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">通过解析root属性来获得3D Tiles数据集的基本信息和结构。</span></span></code></pre></div><h3 id="root-boundingvolume-region" tabindex="-1">root.BoundingVolume.region <a class="header-anchor" href="#root-boundingvolume-region" aria-label="Permalink to &quot;root.BoundingVolume.region&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">1.</span><span style="color:#A6ACCD;"> 最小经度（单位：弧度）</span></span>
<span class="line"><span style="color:#F78C6C;">2.</span><span style="color:#A6ACCD;"> 最小纬度（单位：弧度）</span></span>
<span class="line"><span style="color:#F78C6C;">3.</span><span style="color:#A6ACCD;"> 最小高度（单位：米）</span></span>
<span class="line"><span style="color:#F78C6C;">4.</span><span style="color:#A6ACCD;"> 最大经度（单位：弧度）</span></span>
<span class="line"><span style="color:#F78C6C;">5.</span><span style="color:#A6ACCD;"> 最大纬度（单位：弧度）</span></span>
<span class="line"><span style="color:#F78C6C;">6.</span><span style="color:#A6ACCD;"> 最大高度（单位：米）</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">前三个数字表示长方体的左下角坐标，后三个数字表示长方体的右上角坐标。</span></span>
<span class="line"><span style="color:#A6ACCD;">如果某个瓦片的边界体积完全包含在这个长方体边界体积内，那么该瓦片就需要加载和渲染。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">需要注意的是，</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">region</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> 属性中的经纬度坐标是以弧度为单位的，而高度是以米为单位的。如果你需要使用度数表示经纬度坐标，可以将其乘以 </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">Math.PI / 180</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> 进行转换。同样的，如果你需要使用英尺表示高度，可以将其乘以 </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">3.28084</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> 进行转换。</span></span></code></pre></div><h2 id="源码" tabindex="-1">源码 <a class="header-anchor" href="#源码" aria-label="Permalink to &quot;源码&quot;">​</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">	createBoundingVolume</span></span>
<span class="line"><span style="color:#A6ACCD;">	createRegion</span></span>
<span class="line"><span style="color:#A6ACCD;">		可选createBoxFromTransformedRegion</span></span>
<span class="line"><span style="color:#A6ACCD;">例如：</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">Cesium3DTileset</span><span style="color:#A6ACCD;"> (Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">1035</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">then（异步）</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">loadTileset</span><span style="color:#A6ACCD;"> (Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">2234</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">makeTile</span><span style="color:#A6ACCD;"> (Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">2289</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">Cesium3DTile</span><span style="color:#A6ACCD;"> (Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">110</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createBoundingVolume</span><span style="color:#A6ACCD;"> (Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">1781</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#FFCB6B;">三个分支</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">		createBox </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> createRegion </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> createSphere </span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#FFCB6B;">对应</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">		TileOrientedBoundingBox </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> TileBoundingRegion </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> TileBoundingSphere</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js在构造函数阶段会保存原始的、未转换的边界体积位置，以便我们可以应用运行时的瓦片变换和模型矩阵</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> boundingVolume </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> that</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">_root</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createBoundingVolume</span><span style="color:#A6ACCD;">(tilesetJson</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">root</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">boundingVolume </span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> Matrix4</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IDENTITY)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">打断点看createBoundingVolume的结果</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">B3dmLoader</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">B3dmLoader</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">load </span></span>
<span class="line"><span style="color:#A6ACCD;">		batchTableJson定义了一个b3dm文件里面多个gltf模型各自的属性</span></span></code></pre></div><h3 id="customshader渲染堆栈" tabindex="-1">CustomShader渲染堆栈 <a class="header-anchor" href="#customshader渲染堆栈" aria-label="Permalink to &quot;CustomShader渲染堆栈&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">CustomShader渲染堆栈：</span></span>
<span class="line"><span style="color:#A6ACCD;">    CustomShaderPipelineStage</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">process</span><span style="color:#A6ACCD;"> (CustomShaderPipelineStage</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">74</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> PrimitiveRenderResources</span></span>
<span class="line"><span style="color:#A6ACCD;">    ModelSceneGraph</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">buildDrawCommands</span><span style="color:#A6ACCD;"> (ModelSceneGraph</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">527</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">buildDrawCommands</span><span style="color:#A6ACCD;"> (Model</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">1967</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Model</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">1796</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">processLoader分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    Model3DTileContent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Model3DTileContent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">246</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">process</span><span style="color:#A6ACCD;"> (Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">1965</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">processTiles</span><span style="color:#A6ACCD;"> (Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">2500</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">prePassesUpdate</span><span style="color:#A6ACCD;"> (Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">2352</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    PrimitiveCollection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">prePassesUpdate</span><span style="color:#A6ACCD;"> (PrimitiveCollection</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">392</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">prePassesUpdate</span><span style="color:#A6ACCD;"> (Scene</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">3648</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">tryAndCatchError</span><span style="color:#A6ACCD;"> (Scene</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">3745</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Scene4</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;"> (Scene</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">3814</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    CesiumWidget</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;"> (CesiumWidget</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">802</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;"> (CesiumWidget</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">41</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><h3 id="b3dm处理" tabindex="-1">b3dm处理 <a class="header-anchor" href="#b3dm处理" aria-label="Permalink to &quot;b3dm处理&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">processLoader分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">	B3dmLoader的createStructuralMetadata </span><span style="color:#89DDFF;">,/</span><span style="color:#A6ACCD;">此处可获取gltf的components</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">structuralMetadata</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">propertyTables[</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">]</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">_jsonMetadataTable</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">_properties模型的属性</span></span>
<span class="line"><span style="color:#A6ACCD;">	GltfLoader</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">parse</span></span>
<span class="line"><span style="color:#A6ACCD;">	GltfLoader</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">loadResources</span></span>
<span class="line"><span style="color:#A6ACCD;">    GltfLoader</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">process</span></span>
<span class="line"><span style="color:#A6ACCD;">    B3dmLoader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">process</span><span style="color:#A6ACCD;"> (B3dmLoader</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">294</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Model的processLoader</span></span>
<span class="line"><span style="color:#A6ACCD;">    Model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Model</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">1821</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Model3DTileContent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">update</span></span></code></pre></div><h3 id="在主更新循环中调用3dtile的更新方法" tabindex="-1">在主更新循环中调用3dtile的更新方法 <a class="header-anchor" href="#在主更新循环中调用3dtile的更新方法" aria-label="Permalink to &quot;在主更新循环中调用3dtile的更新方法&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">在主更新循环中调用3dtile的更新方法</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">updateTiles (Cesium.js:107633)分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">requestTiles (Cesium.js:107407)分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;">(tileset</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> frameState</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> passStatistics</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> passOptions)  (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">107784</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">updateForPass</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">107829</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Cesium3DTileset</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">107800</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    PrimitiveCollection</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">122827</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Scene的updateAndRenderPrimitives   </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Scene的executeCommand分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">executeCommandsInViewport</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">200077</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">//MapGIS洪水淹没分析的原理</span></span>
<span class="line"><span style="color:#A6ACCD;">        FloodAnalysis</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (FloodAnalysis</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;">7cc9</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">510</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        VisualAnalysisManager</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (VisualAnalysisManager</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;">3a15</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">131</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">updateAnalysis</span><span style="color:#A6ACCD;"> (Scene</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span><span style="color:#89DDFF;">?</span><span style="color:#F78C6C;">5811</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">2857</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">executeCommandsInViewport</span><span style="color:#A6ACCD;"> (Scene</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span><span style="color:#89DDFF;">?</span><span style="color:#F78C6C;">5811</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">2889</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    Scene4</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">updateAndExecuteCommands</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">199895</span><span style="color:#A6ACCD;">)</span><span style="color:#676E95;font-style:italic;">/*用于更新场景中的命令（比如绘制几何体、更新相机等）并执行这些命令*/</span><span style="color:#A6ACCD;"> resolveFramebuffers</span><span style="color:#676E95;font-style:italic;">/*同级下一行代码，用于将场景渲染的结果输出到屏幕上*/</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;">(scene) (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">200533</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">tryAndCatchError</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">200547</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Scene4</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;">(Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">200599</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    CesiumWidget</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">212473</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    起点：</span><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;">(frameTime) (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">212033</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><h3 id="scene的executecommand分支" tabindex="-1">&#39;Scene的executeCommand分支&#39; <a class="header-anchor" href="#scene的executecommand分支" aria-label="Permalink to &quot;&#39;Scene的executeCommand分支&#39;&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">分支们：</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Scene的executeCommand分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            Context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">continueDraw</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">32629</span><span style="color:#A6ACCD;">)  </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Context的beginDraw分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            Context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">draw</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">32685</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            DrawCommand</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">18200</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                DrawCommand，是 Cesium 封装 WebGL 的一个优秀设计，它把绘图数据（VertexArray）和绘图行为（ShaderProgram）作为一个对象，待时机合适，也就是 Scene 执行 executeCommand 函数时，帧状态对象上所有的指令对象就会使用 WebGL 函数执行，要什么就 bind 什么，做到了在绘图时的用法一致，上层应用接口只需生成指令对象。</span></span>
<span class="line"><span style="color:#A6ACCD;">                    VertexArray</span><span style="color:#676E95;font-style:italic;">//Cesium 把 WebGL 的顶点缓冲和索引缓冲包装成了 Buffer，然后为了方便，将这些顶点相关的缓冲绑定在了一个对象里，叫做 VertexArray，内部会启用 WebGL 的 VAO 功能。</span></span>
<span class="line"><span style="color:#A6ACCD;">                    ShaderProgram</span><span style="color:#676E95;font-style:italic;">//着色器代码由 ShaderSource 管理，ShaderProgram 则管理起多个着色器源码，也就是着色器本身。使用 ShaderCache 作为着色器程序的缓存容器。</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">Scene的executeCommand</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">199593</span><span style="color:#A6ACCD;">) </span><span style="color:#676E95;font-style:italic;">//遍历了frustumCommands.commands[Pass_default.GLOBE]</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Context的beginDraw分支</span><span style="color:#89DDFF;">&#39;/</span><span style="color:#C3E88D;">context._gl.drawElements和context._gl.drawArrays在此执行</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">                                        </span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">createAndLinkProgram</span><span style="color:#A6ACCD;"> (ShaderProgram</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">213</span><span style="color:#A6ACCD;">) 在gl</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">linkProgram</span><span style="color:#A6ACCD;">(program)打断点可以看到fsSource</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">vsSource即WebGL的shader代码，                    </span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">reinitialize</span><span style="color:#A6ACCD;"> (ShaderProgram</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">470</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">initialize</span><span style="color:#A6ACCD;"> (ShaderProgram</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">463</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                    ShaderProgram</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_bind</span><span style="color:#A6ACCD;"> (ShaderProgram</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">542</span><span style="color:#A6ACCD;">) </span><span style="color:#FFCB6B;">在ShaderProgram</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">_bind打条件断点this</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">_fragmentShaderText</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">includes</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">特殊标识</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)可以找到CustomShader在合成后的shader代码</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#82AAFF;">beginDraw</span><span style="color:#A6ACCD;"> (Context</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">1291</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><h3 id="requesttiles-cesium-js-107407-分支" tabindex="-1">&#39;requestTiles (Cesium.js:107407)分支&#39; <a class="header-anchor" href="#requesttiles-cesium-js-107407-分支" aria-label="Permalink to &quot;&#39;requestTiles (Cesium.js:107407)分支&#39;&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">requestTiles (Cesium.js:107407)分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            ForEach</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">topLevel</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">65203</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            ForEach</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">material</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">65319</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">addDefaults</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">65581</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            （匿名） (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">68270</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">then（异步）</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">processGltfJson</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">68269</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">processGltfTypedArray</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">68284</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            GltfJsonLoader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">68172</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            ResourceCache</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">69956</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            ResourceCache</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">loadGltfJson</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">70067</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            GltfLoader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">74203</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            B3dmLoader</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">load</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">76938</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">initialize19</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">88021</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">Model</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">87953</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            Model</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fromB3dm</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">89114</span><span style="color:#A6ACCD;">) </span></span>
<span class="line"><span style="color:#A6ACCD;">	            本质是modelMatrix决定了位置而 ModelSceneGraph</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">buildDrawCommands 用 ModelDrawCommand 决定了 </span><span style="color:#FFCB6B;">modelMatrix取决于</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">		            1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">this</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">runtimePrimitive</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">boundingSphere</span><span style="color:#676E95;font-style:italic;">//取决于GLTF中定义的scene.nodes[i].primitives[j].attributes[k].min|max的xyz坐标  </span></span>
<span class="line"><span style="color:#A6ACCD;">					2</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">this</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">_modelMatrix</span><span style="color:#676E95;font-style:italic;">//取决与我们代码传入的modelMatrix  </span></span>
<span class="line"><span style="color:#A6ACCD;">					3</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">this</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">_boundingVolume </span><span style="color:#676E95;font-style:italic;">//取决于GLTF中定义的scene.nodes[i].primitives[j].attributes[k].min|max的xyz坐标, 但还判断是场景是2D模式还是3D模式</span></span>
<span class="line"><span style="color:#89DDFF;">	            </span><span style="color:#676E95;font-style:italic;">//是 model._boundingSphere</span></span>
<span class="line"><span style="color:#89DDFF;">	            </span><span style="color:#676E95;font-style:italic;">//是 model._sceneGraph.boundingSphere.center </span></span>
<span class="line"><span style="color:#89DDFF;">	            </span><span style="color:#676E95;font-style:italic;">//是 ModelSceneGraph.js 的 ModelSceneGraph.buildDrawCommands的model 的 </span></span>
<span class="line"><span style="color:#89DDFF;">		            </span><span style="color:#676E95;font-style:italic;">//this._boundingSphere = BoundingSphere.fromCornerPoints(primitiveRenderResources.positionMin 和 positionMax)</span></span>
<span class="line"><span style="color:#89DDFF;">	            </span><span style="color:#676E95;font-style:italic;">//是 PrimitiveRenderResources 的 runtimePrimitive.primitive.attributes[0]是:</span></span>
<span class="line"><span style="color:#A6ACCD;">						</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">POSITION</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">semantic</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">POSITION</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">componentDatatype</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#F78C6C;">5126</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">VEC3</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">normalized</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">count</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#F78C6C;">240</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">						    </span><span style="color:#676E95;font-style:italic;">//位置就藏在这里!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span>
<span class="line"><span style="color:#F07178;">						     </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">min</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">x</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1214922.0063094844</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">y</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">4736399.2068924345</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">z</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4081525.4477709476</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">                                </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">max</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">x</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1215121.59033861</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">y</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">4736238.163863403</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">z</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4081670.8300574976</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">constant</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">x</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">y</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">z</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">buffer</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">						        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">_id</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a3ded257-2908-4de7-9476-4baa2a022801</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">_gl</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{},</span></span>
<span class="line"><span style="color:#F07178;">						        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">_webgl2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">_bufferTarget</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">34962</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">_sizeInBytes</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2880</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">_usage</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">35044</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">_buffer</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{},</span></span>
<span class="line"><span style="color:#F07178;">						        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">vertexArrayDestroyable</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">byteOffset</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">						    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">byteStride</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#F78C6C;">12</span></span>
<span class="line"><span style="color:#F07178;">						</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">				</span><span style="color:#676E95;font-style:italic;">//primitive是ModelSceneGraph.traverseAndCreateSceneGraph把ModelSceneGraph._components.scene.nodes[i].rootNode.primitives[j]传给new ModelRuntimePrimitive再推进runtimePrimitive数组的</span></span>
<span class="line"><span style="color:#89DDFF;">				</span><span style="color:#676E95;font-style:italic;">//primitive.attributes 本质是GltfLoader.js构造的node,见[[Cesium-GLTF#components]]</span></span>
<span class="line"><span style="color:#A6ACCD;">            Model3DTileContent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fromB3dm</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">89456</span><span style="color:#A6ACCD;">) </span><span style="color:#676E95;font-style:italic;">//modelMatrix: tile.computedTransform, //modelMatrix其实是tile的computedTransform</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">b3dm</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">99387</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">makeContent</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">104921</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            （匿名） (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">104859</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">then（异步）</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">requestSingleContent</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">104854</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">requestContent</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">104758</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            Cesium3DTile_default</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">requestContent</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">182512</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">requestContent</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">107323</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">requestTiles</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">107407</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">updateTiles (Cesium.js:107633)分支</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">            Model3DTileContent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">89408</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">updateContent</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">105303</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">105320</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#82AAFF;">updateTiles</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">107633</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><h3 id="是怎么构造请求b3dm的url" tabindex="-1">是怎么构造请求b3dm的url? <a class="header-anchor" href="#是怎么构造请求b3dm的url" aria-label="Permalink to &quot;是怎么构造请求b3dm的url?&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">Cesium3DTile</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">constructor</span></span>
<span class="line"><span style="color:#A6ACCD;">	baseResource</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getDerivedResource 即 </span><span style="color:#FFCB6B;">Resource</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getDerivedResource</span></span></code></pre></div><h2 id="boundingvolume下的region举例" tabindex="-1">BoundingVolume下的region举例 <a class="header-anchor" href="#boundingvolume下的region举例" aria-label="Permalink to &quot;BoundingVolume下的region举例&quot;">​</a></h2><p>下面是一个 <code>BoundingVolume</code> 中 <code>region</code> 属性的示例：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&quot;boundingVolume&quot;: {</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;region&quot;: [</span></span>
<span class="line"><span style="color:#A6ACCD;">        -1.7453292519943295,</span></span>
<span class="line"><span style="color:#A6ACCD;">        0.6632251157578453,</span></span>
<span class="line"><span style="color:#A6ACCD;">        0,</span></span>
<span class="line"><span style="color:#A6ACCD;">        -1.7452406437283515,</span></span>
<span class="line"><span style="color:#A6ACCD;">        0.6633137240238233,</span></span>
<span class="line"><span style="color:#A6ACCD;">        500</span></span>
<span class="line"><span style="color:#A6ACCD;">    ]</span></span>
<span class="line"><span style="color:#A6ACCD;">},</span></span></code></pre></div><p>在这个示例中，<code>region</code> 属性表示一个长方体边界体积的范围信息，其包含了 6 个数字。前三个数字 <code>-1.7453292519943295, 0.6632251157578453, 0</code> 表示长方体的左下角坐标，其中 <code>-1.7453292519943295</code> 表示最小经度，<code>0.6632251157578453</code> 表示最小纬度，<code>0</code> 表示最小高度。后三个数字 <code>-1.7452406437283515, 0.6633137240238233, 500</code> 表示长方体的右上角坐标，其中 <code>-1.7452406437283515</code> 表示最大经度，<code>0.6633137240238233</code> 表示最大纬度，<code>500</code> 表示最大高度。</p><p>这个示例中的 <code>BoundingVolume</code> 表示一个位于地球表面某个区域的长方体边界体积，其最小经度为 <code>-99.99999999999996</code> 度，最小纬度为 <code>19.999999999999975</code> 度，最小高度为 <code>0</code> 米，最大经度为 <code>-99.99999999999994</code> 度，最大纬度为 <code>20.000000000000007</code> 度，最大高度为 <code>500</code> 米。如果某个瓦片的边界体积完全包含在这个长方体边界体积内，那么该瓦片就需要加载和渲染。</p><h2 id="实践" tabindex="-1">实践 <a class="header-anchor" href="#实践" aria-label="Permalink to &quot;实践&quot;">​</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">3</span><span style="color:#FFCB6B;">DTiles</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    tileset</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">boundingSphere</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//取得图层的坐标范围 tileset.boundingSphere.center为{ x: -181.90666255179437, y: -172.06516955205194, z: 1679.9689450075364 }</span></span>
<span class="line"><span style="color:#A6ACCD;">    viewer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">scene</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">primitives</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#A6ACCD;">(tileset)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//添加到球体上  //primitives：图元 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">提升tiles加载性能速度</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">开启 gzip压缩</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">传输的数据能节省小一半</span></span>
<span class="line"><span style="color:#A6ACCD;">    2</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">换转换工具</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">减少单个tile的大小</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">减少索引Tile的个数</span><span style="color:#A6ACCD;">(即增加</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">json文件个数)</span></span>
<span class="line"><span style="color:#A6ACCD;">    3</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">几个影响加载效率的关键参数：</span></span>
<span class="line"><span style="color:#A6ACCD;">        1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">maximumScreenSpaceError</span><span style="color:#676E95;font-style:italic;">//数据的清晰度,越大越粗糙,这个参数默认是16，只要是lab输出的数据，我们已经考虑这个默认值了，所以一般情况下，不需要修改        </span></span>
<span class="line"><span style="color:#A6ACCD;">        2</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">skipLevelOfDetail </span><span style="color:#676E95;font-style:italic;">//对于网络条件好，并且数据总量较小的情况下，可以设置false，提升数据显示质量        </span></span>
<span class="line"><span style="color:#A6ACCD;">        3</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">preferLeaves </span><span style="color:#676E95;font-style:italic;">//配合skipLevelOfDetail=true来设置preferLeaves=true。这样我们就能最快的看见符合当前视觉精度的块，对于提升大数据以及网络环境不好的前提下有一点点改善意义。        </span></span>
<span class="line"><span style="color:#A6ACCD;">        4</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">maximumMemoryUsage</span><span style="color:#676E95;font-style:italic;">//这个值应该处于最差视角下资源占用 和 显存最大量之间            </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        viewer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">resolutionScale </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> 小于1 </span><span style="color:#676E95;font-style:italic;">//降低画布分辨率</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        viewer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">scene</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">requestRenderMode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//启用requestRenderMode可减少Cesium渲染新帧的总时间并减少Cesium在应用程序中的总体CPU使用率。</span></span>
<span class="line"><span style="color:#A6ACCD;">        viewer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">scene</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">maximumRenderTimeChange</span><span style="color:#89DDFF;">=Infinity</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">//没用到时间相关的动画的话,就这样设置</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">开启后有些情况需要调用强制重新渲染</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> scene</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">requestRender</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h3 id="tileset-root-content是empty3dtilecontent-是怎么回事" tabindex="-1">tileset.root.content是Empty3DTileContent 是怎么回事 <a class="header-anchor" href="#tileset-root-content是empty3dtilecontent-是怎么回事" aria-label="Permalink to &quot;tileset.root.content是Empty3DTileContent 是怎么回事&quot;">​</a></h3><p>在Cesium中，<code>Empty3DTileContent</code> 是一个特殊的类，用于表示一个没有内容的 3D 瓦片。如果 <code>tileset.root.content</code> 是 <code>Empty3DTileContent</code>，则这意味着根瓦片不包含任何几何和纹理数据。这通常发生在以下两种情况下：</p><ol><li>当您创建一个新的空 <code>Cesium3DTileset</code> 时，其根瓦片会自动设置为空。</li><li>在加载一个包含根瓦片的 Cesium3DTiles 数据集时，如果根瓦片没有包含实际的几何和纹理数据，则它将被解析为 <code>Empty3DTileContent</code>。试试从<code>tileset.root.children[0].content</code>拿</li></ol><p>需要注意的是，即使根瓦片没有几何和纹理数据，仍然可以使用CesiumJS API对其进行操作和渲染。例如，在根瓦片上设置样式、添加事件处理程序或调整光照设置等。此外，根瓦片可能包含有关数据集的元数据，如边界框信息、时间戳、投影信息等。</p><h2 id="b3dm的文件结构" tabindex="-1">b3dm的文件结构 <a class="header-anchor" href="#b3dm的文件结构" aria-label="Permalink to &quot;b3dm的文件结构&quot;">​</a></h2><p>b3dm文件（Batched 3D Model）是一种基于glTF格式的3D模型数据格式，主要用于地理信息系统（GIS）中的三维建模、可视化和分析。其文件结构包括以下几个主要部分：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">1. glTF头部信息：包括文件大小、版本号、模型名称、场景等元数据。</span></span>
<span class="line"><span style="color:#A6ACCD;">2. 二进制数据：包括模型的顶点坐标、法线、纹理坐标等信息，使用二进制格式进行存储。</span></span>
<span class="line"><span style="color:#A6ACCD;">3. 特性表数据（Batch Table）：可选的元数据表格，用于存储模型的自定义属性信息。</span></span>
<span class="line"><span style="color:#A6ACCD;">4. 特性实例数据（Batch Table Instance）：可选的实例表格，用于存储每个实例的自定义属性信息。</span></span>
<span class="line"><span style="color:#A6ACCD;">5. 批处理数据（Batch）：存储三角形网格和所需的材质、纹理等信息，以及对应的特性表和特性实例表索引。</span></span></code></pre></div><h3 id="b3dm文件结构中-material存在哪里" tabindex="-1">b3dm文件结构中，material存在哪里 <a class="header-anchor" href="#b3dm文件结构中-material存在哪里" aria-label="Permalink to &quot;b3dm文件结构中，material存在哪里&quot;">​</a></h3><p>在b3dm文件结构中，材质（Material）信息存储在Batch中。Batch是一个表示渲染批次的数据块，可以包含一个或多个三角形网格，以及对应的材质信息和特性表数据。每个Batch数据块的结构如下所示：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;primitive&quot;:&lt;number&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;centroid&quot;:&lt;array&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;batchLength&quot;:&lt;number&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;batchTableJSON&quot;:&lt;object&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;batchTableBinary&quot;:&lt;arrayBuffer&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;gltfFormat&quot;:&lt;number&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;attributeName&quot;:&lt;string&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;attributes&quot;:&lt;arrayBuffer&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>其中，Batch中的&quot;attributes&quot;字段包含了模型的顶点坐标、法线、纹理坐标等信息，同时也包含了材质信息。材质信息可以在Batch中通过以下字段进行定义：</p><ul><li><p>&quot;material&quot;：用于指定Batch的材质，在glTF中对应于material数组中的索引。例如，可以使用以下指令来与Batch关联材质：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&quot;material&quot;:0</span></span></code></pre></div></li><li><p>&quot;attributes&quot;：用于指定Batch的渲染属性，例如它的纹理坐标。其中，纹理坐标通常存储在gltf中的二进制buffer中，并使用实际坐标值和对应的偏移量进行索引。例如：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&quot;attributes&quot;:{</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;TEXCOORD_0&quot;: {</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;bufferView&quot;: 1,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;componentType&quot;: 5126,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;count&quot;: 7392,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;type&quot;: &quot;VEC2&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;byteOffset&quot;: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div></li></ul><p>通过Batch的材质和渲染属性信息，b3dm文件格式可以支持多种不同的纹理、材质和渲染效果。</p><h2 id="bim转3dtiles" tabindex="-1">BIM转3DTiles <a class="header-anchor" href="#bim转3dtiles" aria-label="Permalink to &quot;BIM转3DTiles&quot;">​</a></h2><h3 id="前置知识" tabindex="-1">前置知识 <a class="header-anchor" href="#前置知识" aria-label="Permalink to &quot;前置知识&quot;">​</a></h3><ol><li><a href="https://community.safe.com/s/article/revit-geolocation-tutorial" target="_blank" rel="noreferrer">Revit Geolocation</a></li><li><a href="https://help.autodesk.com/view/RVT/2018/CHS/?guid=GUID-9DD9DCDB-F80F-4FCE-BA87-FE49B66936CF" target="_blank" rel="noreferrer">帮助 | 关于定位 | Autodesk</a></li><li><a href="https://bimbox.top/9372.html" target="_blank" rel="noreferrer">终于搞清了Revit的5个定位点都是啥？怎么用？怎么对齐？ – BIMBOX</a></li><li>在Autodesk Revit软件中，您可以设置地理位置。Revit软件将此信息用于各种照明和建模过程。<strong>但地理位置信息不足以定义准确的地理空间位置</strong>, 测量点模型附近的真实世界位置, 它对应的测量坐标系才是GIS 坐标<a href="https://help.autodesk.com/view/RVT/2024/CHS/?guid=GUID-E67ED082-2556-475B-84A7-4605329F612F" target="_blank" rel="noreferrer">帮助 | 关于坐标系 | Autodesk</a></li></ol><h3 id="工具" tabindex="-1">工具 <a class="header-anchor" href="#工具" aria-label="Permalink to &quot;工具&quot;">​</a></h3><h4 id="fme-有破解版" tabindex="-1">FME(有破解版) <a class="header-anchor" href="#fme-有破解版" aria-label="Permalink to &quot;FME(有破解版)&quot;">​</a></h4><h5 id="理论" tabindex="-1">理论 <a class="header-anchor" href="#理论" aria-label="Permalink to &quot;理论&quot;">​</a></h5><p><a href="https://docs.safe.com/fme/2022.0/html/FME_Desktop_Documentation/FME_ReadersWriters/revitnative/revitnative_reader.htm" target="_blank" rel="noreferrer">Autodesk Revit Reader 参数</a> 参数: 要读取的 Revit 坐标系 1. 选项目(默认)： 读取器将读取由 Revit 文件的项目基点定义的坐标系中的数据和单位 2. 选地理参考:FME 将在数据集的文件夹中搜索与您的数据集同名但具有投影文件 ( .prj ) 扩展名的文件。如果找不到具有该名称的文件，它将在数据集文件夹中查找文件esri_cad.prj 。 1. 如果这些文件中的任何一个存在，FME 将使用其中包含的坐标系信息对 Revit 文件进行地理定位。 2. 如果找到.prj文件，FME 还将在数据集的文件夹中搜索与您的数据集同名但具有世界文件扩展名（.wld或.wld3）的文件。如果找不到具有该名称的文件，它将在数据集文件夹中查找文件esri_cad.wld / esri_cad.wld3。如果这些文件中的任何一个存在，FME 将使用文件中的信息将数据集中要素的坐标转换为新的地理空间坐标。<a href="https://pro.arcgis.com/en/pro-app/latest/help/data/revit/geospatial-position-of-cad-and-bim-data.htm" target="_blank" rel="noreferrer">CAD 和 BIM 数据的地理空间位置—ArcGIS Pro | 文档</a> 1. 如果未找到.wld/.wld3文件，则转换将继续使用在.prj文件中找到的地理配准信息，同时读取由 Revit 文件的测量点定义的坐标系中的坐标。读者还将使用该文件定义的项目单元。 3. 如果 FME 没有找到 Esri .prj文件，它将在 Revit 数据集中的活动站点上查找地理参考坐标系信息。为了正确地对数据集进行地理配准，Revit 文件需要链接到 Autodesk Revit 中的 DWG 坐标系。如果 FME 在 Revit 数据集中找到地理配准数据，它将生成一个本地 AZMED 投影坐标系来对数据集进行地理配准。读者还将在 SurveyPoint 要素上设置 Revit 文件中找到的坐标系名称以及测量点的经纬度。 4. 如果找不到文件，那么将使用在数据集中找到的坐标信息，而不执行任何额外的转换。</p><h5 id="实践-1" tabindex="-1">实践 <a class="header-anchor" href="#实践-1" aria-label="Permalink to &quot;实践&quot;">​</a></h5><ol><li>调整rvt的测量点</li><li>fme设置reader读取坐标为XY-M</li></ol><h4 id="bimangle-1个月试用-主revit插件-周边小工具" tabindex="-1">BimAngle(1个月试用,主revit插件+周边小工具) <a class="header-anchor" href="#bimangle-1个月试用-主revit插件-周边小工具" aria-label="Permalink to &quot;BimAngle(1个月试用,主revit插件+周边小工具)&quot;">​</a></h4><p><a href="https://mp.weixin.qq.com/s?__biz=MzI0NDkxOTMxOA==&amp;mid=2247483951&amp;idx=1&amp;sn=0e679458b5e8fe120f34919bd1886420&amp;chksm=e9573f56de20b640f936bc2a2eeb5a3e13f8aed9837e8e285c4a2deb874153f027d321ca087f&amp;scene=178&amp;cur_album_id=2209537110058106884#rd" target="_blank" rel="noreferrer">《毕安格 Engine 输出 3D Tiles 教程》之地理配准篇 - (1)概述</a></p><ol><li>从 2019 开始原软件名称 《BimAngle Forge Engine》更名为《BimAngle Engine》；</li><li>2019 年 3 月新增 Express 系列，主要是屏蔽了对 Forge 格式的支持</li></ol>`,61),e=[o];function t(c,r,C,D,y,A){return n(),a("div",null,e)}const u=s(p,[["render",t]]);export{F as __pageData,u as default};

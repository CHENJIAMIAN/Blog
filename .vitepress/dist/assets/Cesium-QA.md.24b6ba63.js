import{_ as s,o as a,c as n,O as l}from"./chunks/framework.4afe7240.js";const i=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"Cesium-QA.md","filePath":"Cesium-QA.md"}'),p={name:"Cesium-QA.md"},o=l(`<h2 id="cesium源码的一些疑问" tabindex="-1">Cesium源码的一些疑问 <a class="header-anchor" href="#cesium源码的一些疑问" aria-label="Permalink to &quot;Cesium源码的一些疑问&quot;">​</a></h2><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">packages/engine/Build/Specs/SpecList.js是干什么的?</span></span>
<span class="line"><span style="color:#A6ACCD;">	是packages/engine/Specs下所有测试用例的打包汇总</span></span></code></pre></div><h2 id="cesium的primitive的性能比entiy高很多吗-如果是-那是为什么" tabindex="-1">cesium的primitive的性能比entiy高很多吗？如果是，那是为什么 <a class="header-anchor" href="#cesium的primitive的性能比entiy高很多吗-如果是-那是为什么" aria-label="Permalink to &quot;cesium的primitive的性能比entiy高很多吗？如果是，那是为什么&quot;">​</a></h2><p>Cesium中的primitive和entity是用于构建三维场景的基本元素。在Cesium中，primitives通常指的是简单几何形状，而entities通常指的是更复杂的对象，如模型、点云数据等。</p><p>就性能方面而言，primitives通常比entities更加轻量级和高效。这是因为primitives通常只包含定义一个基本几何形状所需的最小信息，如位置、大小和颜色等。相比之下，entities则可能包含更多的信息，如层次结构、动画、属性等。在处理大量数据时，使用primitives可以提高渲染性能和响应速度。</p><p>此外，Cesium在渲染场景时采用了一些优化技术，如视锥剔除（frustum culling）和LOD（Level of Detail），这些技术可以进一步提高primitives的性能。视锥剔除可以排除不在当前视图范围内的物体，从而减少不必要的计算。而LOD技术可以根据物体与观察者的距离和大小自适应地选择合适的细节层次，以达到更好的性能和视觉效果。</p><p>总的来说，尽管primitives和entities在Cesium中都有其各自的作用和特点，但由于primitives通常更加轻量级和高效，所以在处理大量数据时，使用primitives可以提高渲染性能和响应速度。</p><h2 id="能被cesium加载terrain数据长什么样子-文件结构是什么样的" tabindex="-1">能被cesium加载terrain数据长什么样子, 文件结构是什么样的 <a class="header-anchor" href="#能被cesium加载terrain数据长什么样子-文件结构是什么样的" aria-label="Permalink to &quot;能被cesium加载terrain数据长什么样子,  文件结构是什么样的&quot;">​</a></h2><p>Quantized Mesh的文件格式是二进制格式，通常使用扩展名为&quot;.terrain&quot;或&quot;.mesh&quot;。这种格式使用了量化技术，将地形数据压缩并存储为二进制格式，从而减小了数据文件的大小。 Quantized Mesh文件包含了地形数据的三角形网格、高度信息、纹理信息、法线信息等。 同时，Quantized Mesh还支持多级细节，可以根据观察者的位置和距离动态加载不同级别的细节，以提高渲染效率。 由于Quantized Mesh的文件格式是二进制格式，因此需要特定的软件或库来读取和处理这种格式的文件。</p><p>Quantized Mesh文件结构包括以下几部分：</p><ol><li>Header：包含文件版本、最小和最大高度、节点数等信息。</li><li>Indices：索引数组，用于描述三角形网格的拓扑结构。</li><li>Positions：顶点位置数组。</li><li>Normals：顶点法线数组。</li><li>Texture Coordinates：顶点纹理坐标数组。</li><li>Octants和Water Mask：用于描述地形切片和水域覆盖。</li></ol><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">terrian文件是二进制</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">末尾json</span></span>
<span class="line"><span style="color:#A6ACCD;">	末尾json包含：</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#FFCB6B;">available</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">) [</span></span>
<span class="line"><span style="color:#A6ACCD;">							[</span></span>
<span class="line"><span style="color:#A6ACCD;">								</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">									</span><span style="color:#F07178;">endX</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#A6ACCD;">									endY: </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">									startX: </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">									startY: </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">								</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">							]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">							 </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">							 </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">84</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">84</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">						 ]</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#FFCB6B;">geometricerror</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">78822.47759060614</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#FFCB6B;">surfacearea</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">256716195410744.53</span></span>
<span class="line"><span style="color:#A6ACCD;">		available数组表示该地形数据分为10个等级，每个等级包含的瓦片数量分别是1，</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">，</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">，</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">，</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">，</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">，</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">，</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">，</span><span style="color:#F78C6C;">84</span><span style="color:#A6ACCD;">，</span><span style="color:#F78C6C;">84</span><span style="color:#A6ACCD;">。这个数组描述了地形数据在空间中组成的树状结构，以便在不同细节级别上进行渲染。</span></span>
<span class="line"><span style="color:#A6ACCD;">		“geometricerror”属性表示该数据的几何误差，即表示每个瓦片在地球表面的最大距离偏差，单位为米。这个属性越小，数据越精细。</span></span>
<span class="line"><span style="color:#A6ACCD;">		surfacearea属性表示该数据所覆盖的地表面积，单位为平方米。</span></span></code></pre></div><p>加载完成后，Cesium会自动根据Quantized Mesh数据生成地形模型，并进行光照和阴影的计算，实现高度感和细节效果。</p><h2 id="源码tools-jsdoc-cesium-template-publish-js被谁调用" tabindex="-1">源码Tools/jsdoc/cesium_template/publish.js被谁调用？ <a class="header-anchor" href="#源码tools-jsdoc-cesium-template-publish-js被谁调用" aria-label="Permalink to &quot;源码Tools/jsdoc/cesium_template/publish.js被谁调用？&quot;">​</a></h2><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> npm run build</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">docs </span></span>
<span class="line"><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> gulp buildDocs</span></span>
<span class="line"><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> gulpfile</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js的buildDocs方法</span></span>
<span class="line"><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> npx jsdoc </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">configure Tools</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">jsdoc</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">conf</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> json </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">pedantic $</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">generatePrivateDocumentation</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> node_modules</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">jsdoc</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> cli</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">generateDocs </span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> template </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">\`\${</span><span style="color:#A6ACCD;">env</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">opts</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">template</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">/publish</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h2 id="百度地图破解获取3d建筑物" tabindex="-1">百度地图破解获取3D建筑物 <a class="header-anchor" href="#百度地图破解获取3d建筑物" aria-label="Permalink to &quot;百度地图破解获取3D建筑物&quot;">​</a></h2><p><a href="https://blog.csdn.net/weixin_39747807/article/details/110460861" target="_blank" rel="noreferrer">解析百度地图api 返回数据_新版百度地图建筑数据含高度解析_weixin_39747807的博客-CSDN博客</a></p><h3 id="堆栈追踪" tabindex="-1">堆栈追踪 <a class="header-anchor" href="#堆栈追踪" aria-label="Permalink to &quot;堆栈追踪&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">负载均衡</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">	webmap0</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">bdimg</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">com </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> webmap1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">bdimg</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">com </span><span style="color:#89DDFF;">====</span><span style="color:#A6ACCD;"> map</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">baidu</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">com </span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">///我们还可以直接从worker返回消息处入手（拦截，伪造https证书替换js），将解析后的顶点缓冲和索引进行解析，直接获得建筑的平面数据和高度。把这些数据保存下来，并通过后期的处理，即可以获得比较完整的百度地图建筑轮廓数据。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">_updateFrame分支2</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> webgl draw矢量瓦片到画布</span></span>
<span class="line"><span style="color:#A6ACCD;">	fo</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">drawElements</span><span style="color:#A6ACCD;">(fo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TRIANGLES</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">element1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fo</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">UNSIGNED_SHORT</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">i</span><span style="color:#A6ACCD;"> (VM1410:formatted:</span><span style="color:#F78C6C;">1337</span><span style="color:#A6ACCD;">)  </span></span>
<span class="line"><span style="color:#A6ACCD;">    （匿名） </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">VM1410</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">formatted</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">1513</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> | &#39;e7</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fm</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fl</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">fk</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> 是drawTileBase3D绘制块 block 的gldraw函数&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">	    </span><span style="color:#676E95;font-style:italic;">//e7大概call了32次drawElements 3D建筑物就显示出来了</span></span>
<span class="line"><span style="color:#A6ACCD;">    drawTileLayer </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">VM1410</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">formatted</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">4371</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;drawBase构建了 building3d 数据&#39; | &#39;drawTileBase3D&#39; | &#39;draw3D -&gt; drawBuildings -&gt; drawBuildingsTile 打断点-&gt; block 的gldraw函数&#39; </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">VM1410</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">formatted</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">4237</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    draw </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">VM1410</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">formatted</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">3150</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">//fj.renderData.base3d有东西时drawTileBase3D</span></span>
<span class="line"><span style="color:#A6ACCD;">	    如    </span></span>
<span class="line"><span style="color:#A6ACCD;">			[</span></span>
<span class="line"><span style="color:#A6ACCD;">				    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">line</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">textureSize</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: [</span><span style="color:#F78C6C;">16</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">16</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">texture</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">MapRes/renxinghengdao16.png</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">lineWidth</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#F78C6C;">8</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: [</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">vertex</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">{},</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">index</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">{}</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">has3D</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">has2D</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">zoomWithMap</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">			    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">			    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">block</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">vertex</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">index</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}},</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">has3D</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">has2D</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#F07178;">			    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">			]</span></span>
<span class="line"><span style="color:#FFCB6B;">_updateFrame分支1</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">接收矢量瓦片数据</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">action</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">loadTileData</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">	    </span><span style="color:#676E95;font-style:italic;">//maponline0 - maponline3负载均衡</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">url</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://maponline0.bdimg.com/pvd/?qt=vtile&amp;param=编码后参数</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">	    </span><span style="color:#676E95;font-style:italic;">//initmap_4213f59.js:formatted的12833行getTilesUrl方法的u变量就是编码前的参数, 如&#39;x=24767&amp;y=5001&amp;z=19&amp;styles=pl&amp;textimg=1&amp;v=088&amp;udt=20230516&amp;json=0&#39;</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">tileInfo</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">col</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">47</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">row</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">zoom</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">useZoom</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">tileTypeName</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">na</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">loopOffsetX</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">        </span></span>
<span class="line"><span style="color:#F07178;">				    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">tileSize</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">512</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">baseTileSize</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">512</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">mercatorSize</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">262144</span><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">	    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">tileKey</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">B_NORMAL_MAP_default_47_10_9_9</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onmessage</span><span style="color:#A6ACCD;"> (worker_wasm_ncq5j1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">1118</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> Worker</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">postMessage（异步）</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">loadTileData</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">15008</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">loadVectorTileData</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">13026</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">loadVectorLayerData</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">12969</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">loadLayerData</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">12862</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> setTimeout（异步）</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">loadLayersData</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">15106</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">update</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">（匿名）) (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">15031</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseClass</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">fire</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseClass</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">dispatchEvent</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">1856</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> 请求渲染</span></span>
<span class="line"><span style="color:#82AAFF;">_updateFrame</span><span style="color:#A6ACCD;"> (VM1410:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">eval</span><span style="color:#A6ACCD;"> (VM1410:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> requestAnimationFrame（异步）</span></span>
<span class="line"><span style="color:#82AAFF;">startRenderThread</span><span style="color:#A6ACCD;"> (VM1410:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">fk</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">zoom_changed</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">fm) (VM1410:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">-</span></span>
<span class="line"><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseClass</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">fire</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseClass</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">dispatchEvent</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">1856</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">_setValue</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">10807</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">render</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">10783</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">l</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_loop</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">4355</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">（匿名） (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">4332</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">requestAnimationFrame（异步）</span></span>
<span class="line"><span style="color:#A6ACCD;">l</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_doStart</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">4331</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">l</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">145</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">_startInfiniteZoomAnimation</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">10776</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">zoomTo</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">10486</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">setZoom</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">3937</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> 事件相关</span></span>
<span class="line"><span style="color:#A6ACCD;">ey</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_onWheelMouse</span><span style="color:#A6ACCD;"> (VM1411:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">ey</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">wheel</span><span style="color:#A6ACCD;"> (VM1411:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">deepzoommousewheel</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">eval) (VM1411:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseClass</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">fire</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">BaseClass</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">dispatchEvent</span><span style="color:#A6ACCD;"> (initmap_4213f59</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:formatted:</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">:</span><span style="color:#F78C6C;">1856</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">eY</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_deepZoomWheel</span><span style="color:#A6ACCD;"> (VM1411:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">i</span><span style="color:#A6ACCD;"> (VM1411:</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">https</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//maponline2.bdimg.com/tile/?qt=vtile&amp;x=3158&amp;y=1180&amp;z=14&amp;styles=pl&amp;udt=20200928&amp;scaler=1&amp;showtext=1</span></span>
<span class="line"><span style="color:#FFCB6B;">https</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//maponline2.bdimg.com/pvd/?qt=vtile&amp;param=xxx</span></span></code></pre></div><h3 id="绘制block的shader-绘制3d建筑" tabindex="-1">绘制block的shader(绘制3D建筑): <a class="header-anchor" href="#绘制block的shader-绘制3d建筑" aria-label="Permalink to &quot;绘制block的shader(绘制3D建筑):&quot;">​</a></h3><blockquote><p>shader定义在mapgl的js(即VM1410,是_jsload函数插入的&lt;script)</p></blockquote><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">precision highp float</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 设定精度为highp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">attribute vec4 a_pos</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 定义顶点位置的attribute变量</span></span>
<span class="line"><span style="color:#A6ACCD;">attribute vec4 a_normal</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 定义顶点法线的attribute变量</span></span>
<span class="line"><span style="color:#A6ACCD;">attribute vec4 a_color</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 定义颜色的attribute变量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">uniform mat4 u_proj_matrix</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 投影矩阵</span></span>
<span class="line"><span style="color:#A6ACCD;">uniform mat4 u_mv_matrix</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 变换矩阵</span></span>
<span class="line"><span style="color:#A6ACCD;">uniform mat4 u_normal_matrix</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 法线变换矩阵</span></span>
<span class="line"><span style="color:#A6ACCD;">uniform vec3 u_side_light_dir</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 侧面光源方向的uniform变量</span></span>
<span class="line"><span style="color:#A6ACCD;">uniform bool u_is_normal</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 判断是否使用法线贴图的uniform变量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">varying vec4 _</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 传递到片元着色器中的颜色和透明度的变量</span></span>
<span class="line"><span style="color:#A6ACCD;">varying float a</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 传递到片元着色器中的偏移量变量</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> vec3 b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec3</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0.06</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.06</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.06</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 光照常量项</span></span>
<span class="line"><span style="color:#A6ACCD;">vec3 c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vec3</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.1</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 光照环境项</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#A6ACCD;">() </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">vec4</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">d</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">u_proj_matrix</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">u_mv_matrix</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a_pos</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 计算投影后的坐标</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">gl_Position</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">d</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 将投影后的坐标赋值给内建变量gl_Position</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">a</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1.</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">500.</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a_pos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">z</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">100.</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 计算偏移量</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">gl_Position</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">z</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">gl_Position</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">z</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 将偏移量加到z坐标上，使得离视点越近的物体显示在更前面</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">u_is_normal</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 如果不使用法线贴图，则将光照环境项设置为0.2</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">c</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">vec3</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">0.2</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0.2</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0.2</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">u_is_normal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a_normal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">vec4</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">0.</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0.</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1.</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1.</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 如果使用法线贴图且面朝向相同，则将传递到片元着色器中的颜色和透明度赋值为a_color</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">_</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a_color</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 否则，计算光照信息</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">vec3</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a_color</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">rgb</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 获取顶点颜色</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">vec3</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">f</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">normalize</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">vec3</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">u_normal_matrix</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a_normal</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 获取法线方向，并标准化</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">vec4</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">g</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">u_mv_matrix</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">vec4</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 获取上方向，并进行矩阵变换</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">vec3</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">h</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">normalize</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">g</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">xyz</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 标准化后的上方向</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">float</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">max</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">0.</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">dot</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">f</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">h</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 进行点积运算，并取最大值</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">vec4</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">j</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">u_mv_matrix</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">vec4</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">u_side_light_dir</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 确定侧面光源方向，并进行矩阵变换</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">vec3</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">k</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">normalize</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">j</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">xyz</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 标准化后的侧面光源方向</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">float</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">l</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">max</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">0.</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">dot</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">f</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">k</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 进行点积运算，并取最大值</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">a_pos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">z</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2.</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 如果z坐标小于2，则计算一个额外的衰减因子m，并将其应用于光照强度中</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">float</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">m</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> (</span><span style="color:#F78C6C;">2.</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a_pos</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">z</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">5.</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">l</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">l</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">_</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">vec4</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">c</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">l</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a_color</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 根据各项因素，计算出传递到片元着色器中的颜色和透明度</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">precision highp float</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">varying vec4 _</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">varying float a</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">float b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4000.0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">float c </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">500.0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#A6ACCD;">() </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//定义浮点数类型的变量 &quot;d&quot; 并赋值为 gl_FragCoord.z / gl_FragCoord.w - a</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">float</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">d</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">gl_FragCoord</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">z</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">gl_FragCoord</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">w</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">a</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//定义浮点数类型的变量 &quot;e&quot; 并赋值为 _.a</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">float</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">_</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//如果 d 大于 b 减去 c</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">d</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">c</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">//重新给 e 赋值为 e 乘以 (b-d) 除以 c</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">d</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">//如果 e 小于等于 0，则不绘制该像素</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0.</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">discard</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">//设置像素颜色为 vec4(_.rgb, e)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">gl_FragColor</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">vec4</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">_</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">rgb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">e</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h3 id="_1-获取shader的a-pos属性-vertexattribpointer得到取值规则" tabindex="-1">1. 获取shader的a_pos属性(vertexAttribPointer得到取值规则) <a class="header-anchor" href="#_1-获取shader的a-pos属性-vertexattribpointer得到取值规则" aria-label="Permalink to &quot;1. 获取shader的a_pos属性(vertexAttribPointer得到取值规则)&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">只在绘制3D建筑即drawBuildingsTile时才进入断点</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">drawBuildingsTile</span><span style="color:#A6ACCD;">(fj[</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">][fl]</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">building3d</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">drawBuildingsTile</span><span style="color:#A6ACCD;">(fj[</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">][fl]</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">building3dMesh</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#A6ACCD;">)</span><span style="color:#676E95;font-style:italic;">//自动跳过百度大厦...</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">在dy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">setVertexAttribPointers打条件断点</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;">即可命中调用</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">block 的gldraw函数</span><span style="color:#89DDFF;">\`</span><span style="color:#FFCB6B;">时的vertexAttribPointer得到取a_pos值方法</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">attributes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length </span><span style="color:#89DDFF;">===</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">attributes</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#A6ACCD;">(</span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">name)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">() </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">a_pos,a_normal,a_color</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> fl</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">name </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">a_pos</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">发现都是</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">vertexAttribPointer</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">0</span><span style="color:#676E95;font-style:italic;">/*着色器程序中的 attribute 变量的位置*/</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">3</span><span style="color:#676E95;font-style:italic;">/*size*/</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">5126</span><span style="color:#676E95;font-style:italic;">/*5126表示浮点数类型的数据*/</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#89DDFF;">undefined</span><span style="color:#676E95;font-style:italic;">/*不进行归一化*/</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">28</span><span style="color:#676E95;font-style:italic;">/*每个顶点数据在数组中占用28个字节*/</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#82AAFF;">a_pos</span><span style="color:#A6ACCD;"> (xyz3个值)</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">(1float4字节) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  12字节</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#82AAFF;">a_normal</span><span style="color:#A6ACCD;"> (顶点法线的xyz3个分量)</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">(1float4字节)  </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  12字节</span></span>
<span class="line"><span style="color:#A6ACCD;">				</span><span style="color:#82AAFF;">a_color</span><span style="color:#A6ACCD;"> (RGBA4个分量) </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> (1个unsigned byte 占用1字节) </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> 4字节</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#F78C6C;">0</span><span style="color:#676E95;font-style:italic;">/*从缓冲区的第一个字节开始读取*/</span></span>
<span class="line"><span style="color:#A6ACCD;">		)</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">//从gl.ARRAY_BUFFER缓冲区按参数指定的规则拿顶点的数据到a_pos</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#82AAFF;">vertexAttribPointer</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5126</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">undefined,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">28</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> )</span><span style="color:#676E95;font-style:italic;">//</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#676E95;font-style:italic;">//从gl.ARRAY_BUFFER缓冲区按参数指定的拿顶点的数据到a_normal</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#82AAFF;">vertexAttribPointer</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5126</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">undefined,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">28</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12</span><span style="color:#A6ACCD;">)</span><span style="color:#676E95;font-style:italic;">//</span></span>
<span class="line"><span style="color:#89DDFF;">		 </span><span style="color:#676E95;font-style:italic;">//从gl.ARRAY_BUFFER缓冲区按参数指定的拿顶点的数据到a_color</span></span>
<span class="line"><span style="color:#A6ACCD;">		 </span><span style="color:#82AAFF;">vertexAttribPointer</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">5121</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">28</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">24</span><span style="color:#A6ACCD;">)</span><span style="color:#676E95;font-style:italic;">//5121代表unsigned byte即0-255 true表示要归一化</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#FFCB6B;">取值示例</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#82AAFF;">三角形的第一个顶点位置为</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0.0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.5</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.0</span><span style="color:#A6ACCD;">)，</span><span style="color:#82AAFF;">法线为</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0.0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1.0</span><span style="color:#A6ACCD;">)，</span><span style="color:#82AAFF;">颜色为</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1.0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0.0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1.0</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#A6ACCD;">dy的this</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">attributes属性是:</span></span>
<span class="line"><span style="color:#A6ACCD;">[</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a_pos</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">components</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">offset</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Float32</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a_normal</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">components</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">offset</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Float32</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">a_color</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">components</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">offset</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">24</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">type</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Uint8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">normalize</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">]</span></span></code></pre></div><h3 id="_2-解析shader的arraybuffer的中根据drawelements定义的顺序的逐个解析顶点" tabindex="-1">2. 解析shader的arrayBuffer的中根据drawElements定义的顺序的逐个解析顶点 <a class="header-anchor" href="#_2-解析shader的arraybuffer的中根据drawelements定义的顺序的逐个解析顶点" aria-label="Permalink to &quot;2. 解析shader的arrayBuffer的中根据drawElements定义的顺序的逐个解析顶点&quot;">​</a></h3><h4 id="block-的gldraw函数e7-i-fm-e-fl-fk-是谁调用" tabindex="-1">block 的gldraw函数e7(i, fm, e, fl, fk)是谁调用 <a class="header-anchor" href="#block-的gldraw函数e7-i-fm-e-fl-fk-是谁调用" aria-label="Permalink to &quot;block 的gldraw函数e7(i, fm, e, fl, fk)是谁调用&quot;">​</a></h4><ul><li><code>drawArea3DTile</code> 6次</li><li><code>drawBuildingsTile</code> 60次</li><li><code>drawTileBase3D</code> 5次</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">e7</span><span style="color:#A6ACCD;">(i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fm</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fl</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fk)</span></span>
<span class="line"><span style="color:#A6ACCD;">	e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">vao1</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#A6ACCD;">(fn</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fj</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">vertex</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">element1)</span><span style="color:#89DDFF;">;</span><span style="color:#FFCB6B;">即e2</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">bind的</span></span>
<span class="line"><span style="color:#A6ACCD;">		fk</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#A6ACCD;">(fo)</span><span style="color:#FFCB6B;">即dy</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">bind可获取到数组</span><span style="color:#676E95;font-style:italic;">//日志断点: &#39;fk.bind&#39;,fk?.arrayBuffer //fk.arrayBuffer就是数组</span></span>
<span class="line"><span style="color:#A6ACCD;">			i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bufferData</span><span style="color:#A6ACCD;">(e</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">arrayBuffer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">STATIC_DRAW)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">		fk</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setVertexAttribPointers</span><span style="color:#A6ACCD;">(fo</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//条件断点: fk.attributes.length ===3 &amp;&amp; fk.attributes.map(i=&gt;i.name).toString() === &#39;a_pos,a_normal,a_color&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">	fn</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">drawElements</span><span style="color:#A6ACCD;">(fn</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TRIANGLES</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">element1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fn</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">UNSIGNED_SHORT</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">)</span><span style="color:#676E95;font-style:italic;">//可获取到顶点元素的顺序</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fm.renderData.building3d就是数组</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">	fm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">renderData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">building3d</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">index</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">element1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span></span>
<span class="line"><span style="color:#A6ACCD;">	e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">element1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">arrayBuffer其实原来等于fm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">renderData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">building3d</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">index只是被置为null了</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">vertex</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">arrayType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">components </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> groupArray </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Array</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">from</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">length</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> Math</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ceil</span><span style="color:#A6ACCD;">(fm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">renderData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">building3d</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">vertex</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">_</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	  fm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">renderData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">building3d</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">vertex</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">slice</span><span style="color:#A6ACCD;">(i </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//按components数拆,也就是分组</span></span>
<span class="line"><span style="color:#A6ACCD;">	fm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">renderData</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">building3d</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">index数组里的值都是[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">groupArray</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">]直接的数</span></span></code></pre></div><h3 id="_3-即可解析出数据" tabindex="-1">3. 即可解析出数据 <a class="header-anchor" href="#_3-即可解析出数据" aria-label="Permalink to &quot;3. 即可解析出数据&quot;">​</a></h3><p><strong>太难了放弃了</strong>, 走到获取到arrayBuffer了,也知道画顶点顺序了,也知道顶点的属性的解析规则了, 下一步就是根据这些去解析了, 而且解析出来的坐标也不知道怎么转为经纬度和高度</p><h2 id="超图源码" tabindex="-1">超图源码 <a class="header-anchor" href="#超图源码" aria-label="Permalink to &quot;超图源码&quot;">​</a></h2><p>SuperMap iClient3D for WebGL这样一款开发包是基于Cesium这样的开源的框架来构建的，而Cesium版本迭代更新的非常快，所以大家在做Web端的三维应用开发时，建议下载最新SuperMap iClient3D for WebGL包</p><p>对比:</p><ul><li><a href="https://www.supermap.com/zh-cn/a/product/11i-iclient-webgl-2022.html" target="_blank" rel="noreferrer">SuperMap iClient3D for WebGL - 三维客户端开发平台 - SuperMap|超图软件</a><ul><li>精简了Cesium包的图片/类/Widgets等资源, 增加更强的粒子系统等</li></ul></li><li><a href="https://www.supermap.com/zh-cn/a/product/11i-iclient-cesium-2022.html" target="_blank" rel="noreferrer">SuperMap iClient3D for Cesium - 三维 GIS 应用程序 - SuperMap|超图软件</a></li></ul><p><a href="http://support.supermap.com.cn:8090/webgl/examples/webgl/editor.html#FlowingPipeLine" target="_blank" rel="noreferrer">support.supermap.com.cn:8090/webgl/examples/webgl/editor.html#FlowingPipeLine</a></p><ol><li>F12搜索<code>clearMemoryImmediately</code>得到<code>debugger:///VM86</code>里源码(<strong>是16进制混淆后的Cesium.js执行eval生成的</strong>)</li><li>格式化是个难题, devtool格式化没反应, oschina的js格式化网址格式化完正则格式化出语法错误了,用prettier的npx工具也不行, <ul><li><a href="https://json-online.com/code/js1.html" target="_blank" rel="noreferrer">JS格式化_JS代码格式化-JSON在线工具 (json-online.com)</a>可以</li></ul></li><li>deuglify <ol><li>set NODE_OPTIONS=&quot;--max-old-space-size=8096&quot;</li><li>要求do和while之间用{}括起来</li><li>没有eval(..)语句</li><li>deuglify完事后, break a_xxx;语句替换错误了,手动改一下</li></ol></li></ol><h4 id="流动管线效果实现" tabindex="-1">流动管线效果实现 <a class="header-anchor" href="#流动管线效果实现" aria-label="Permalink to &quot;流动管线效果实现&quot;">​</a></h4><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">line</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">textureUVSpeed </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Cartesian2</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">setter</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">traverseRenderEntity</span><span style="color:#A6ACCD;">(xyspeed</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> YKa)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#FFCB6B;">YKa回调了RenderEntityPagedLOD</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">enableTextureMove</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">appendProgramDefine</span><span style="color:#A6ACCD;">(options</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ProgramDefines</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">TEXTURE_MOVE)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#FFCB6B;">glsl</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> gl_FragColor</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">rgb </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> uEmissionColor</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">rgb </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> baseColor</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">rgb</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">			baseColor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> baseColor </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> outTexColor</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">				vec4 baseColor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> vColor</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">				vec4 outTexColor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getTextureColor</span><span style="color:#A6ACCD;">(realTexCoord</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> firstColor</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> secColor)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">					</span><span style="color:#FFCB6B;">getTextureColor里</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> czm_getTexColorForS3M用了u_MaterialDynamicParameter</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">texUVOffset作为texUVoffset</span></span>
<span class="line"><span style="color:#A6ACCD;">						最后影响了outTexCoord</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">xy也就是realTexCoord也就影响了outTexColor</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">渲染时源码</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#A6ACCD;">		S3MUniformMapCreator</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">createDynamicMaterialUniform</span></span>
<span class="line"><span style="color:#A6ACCD;">		改变了uniformMap</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">uTexUVOffset</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">201017</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#FFCB6B;">glsl</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> u_MaterialDynamicParameter</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">texUVOffset </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> uTexUVOffset</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">		ShaderProgram</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_setUniforms</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">157907</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		Context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">draw</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">254764</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">S3MUniformMapCreator</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">createDynamicMaterialUniform</span></span>
<span class="line"><span style="color:#A6ACCD;">	S3MUniformMapCreator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createDynamicMaterialUniform</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">201016</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	S3MUniformMapCreator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">201069</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	RenderEntityPagedLOD</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createCommand</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">205697</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	RenderEntityPagedLOD</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createAllCommands</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">205327</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	RenderEntityPagedLOD</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">transformResource</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">204509</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	RenderEntityPagedLOD</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">204732</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	S3MLayerScheduler</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_updateRenderQueue</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">216818</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	S3MLayerScheduler</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">216782</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	S3MTilesLayer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">update</span><span style="color:#A6ACCD;"> (Cesium</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js:</span><span style="color:#F78C6C;">224798</span><span style="color:#A6ACCD;">)</span></span></code></pre></div>`,38),t=[o];function e(r,c,y,D,F,C){return a(),n("div",null,t)}const u=s(p,[["render",e]]);export{i as __pageData,u as default};
